rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    
    // Verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si el usuario es el propietario
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validar que tenga campos requeridos
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // Validar string con longitud
    function isValidString(value, minLen, maxLen) {
      return value is string 
        && value.size() >= minLen 
        && value.size() <= maxLen;
    }
    
    // Verificar si el usuario es administrador
    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'estebanber24@gmail.com';
    }
    
    // ============================================
    // PERFILES
    // ============================================
    match /perfiles/{userId} {
      // Lectura: Pública (permite modo invitado)
      allow read: if true;
      
      // Crear: Solo el usuario correspondiente
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && hasRequiredFields(['nombre', 'email', 'type', 'uid']);
      
      // Actualizar: El propietario O actualización de seguidores/siguiendo O el administrador
      allow update: if isOwner(userId) ||
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['seguidores', 'siguiendo'])) ||
                      isAdmin();
      
      // Eliminar: Solo el propietario o el administrador
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // PUBLICACIONES
    // ============================================
    match /publicaciones/{postId} {
      // Lectura: Pública (permite modo invitado)
      allow read: if true;
      
      // Crear: Usuario autenticado, debe ser el autor
      allow create: if isAuthenticated() 
        && request.resource.data.autorUid == request.auth.uid
        && hasRequiredFields(['titulo', 'descripcion', 'autorUid', 'createdAt']);
      
      // Actualizar/Eliminar: Solo el autor o el administrador
      allow update, delete: if isAuthenticated() 
        && (resource.data.autorUid == request.auth.uid || isAdmin());
      
      // Subcolección: Comentarios de publicaciones
      match /comentarios/{commentId} {
        allow read: if true;
        allow create: if isAuthenticated()
          && request.resource.data.autorUid == request.auth.uid;
        allow update, delete: if isAuthenticated() 
          && resource.data.autorUid == request.auth.uid;
      }
      
      // Subcolección: Reacciones/Likes
      match /reacciones/{reactionId} {
        allow read: if true;
        allow create, delete: if isAuthenticated() 
          && request.auth.uid == reactionId;
      }
    }
    
    // ============================================
    // PRODUCTOS (MusicMarket)
    // ============================================
    match /productos/{productId} {
      // Lectura: Pública (permite modo invitado)
      allow read: if true;
      
      // Crear: Usuario autenticado, debe ser el vendedor
      allow create: if isAuthenticated() 
        && request.resource.data.vendedorUid == request.auth.uid
        && hasRequiredFields(['nombre', 'precio', 'vendedorUid', 'createdAt'])
        && request.resource.data.precio is number
        && request.resource.data.precio > 0;
      
      // Actualizar: El vendedor puede actualizar todo, otros usuarios solo rating y resenas
      allow update: if isAuthenticated() && 
        (resource.data.vendedorUid == request.auth.uid ||
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'resenas']));
      
      // Eliminar: Solo el vendedor o el administrador
      allow delete: if isAuthenticated() 
        && (resource.data.vendedorUid == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // EVENTOS
    // ============================================
    match /eventos/{eventId} {
      // Lectura: Pública (permite modo invitado)
      allow read: if true;
      
      // Crear: Usuario autenticado, debe ser el creador
      allow create: if isAuthenticated() 
        && request.resource.data.creadorUid == request.auth.uid
        && hasRequiredFields(['titulo', 'fecha', 'creadorUid', 'createdAt']);
      
      // Actualizar: Creador puede editar todo, otros solo asistentes
      allow update: if isAuthenticated() 
        && (resource.data.creadorUid == request.auth.uid 
        || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['asistentes']));
      
      // Eliminar: Solo el creador o el administrador
      allow delete: if isAuthenticated() 
        && (resource.data.creadorUid == request.auth.uid || isAdmin());
      
      // Subcolección: Comentarios de eventos
      match /comentarios/{commentId} {
        allow read: if true;
        allow create: if isAuthenticated()
          && request.resource.data.autorUid == request.auth.uid;
        allow update, delete: if isAuthenticated() 
          && resource.data.autorUid == request.auth.uid;
      }
    }
    
    // ============================================
    // CONVERSACIONES (Chat)
    // ============================================
    match /conversaciones/{conversationId} {
      // Lectura: Solo participantes
      allow read: if isAuthenticated() 
        && request.auth.uid in resource.data.participantes;
      
      // Crear: Usuario debe estar en participantes
      allow create: if isAuthenticated()
        && request.auth.uid in request.resource.data.participantes;
      
      // Actualizar: Solo participantes
      allow update: if isAuthenticated() 
        && request.auth.uid in resource.data.participantes;
      
      // Eliminar: No permitido
      allow delete: if false;
      
      // Subcolección: Mensajes
      match /mensajes/{messageId} {
        allow read: if isAuthenticated() 
          && request.auth.uid in get(/databases/$(database)/documents/conversaciones/$(conversationId)).data.participantes;
        allow create: if isAuthenticated()
          && request.resource.data.emisorUid == request.auth.uid
          && request.auth.uid in get(/databases/$(database)/documents/conversaciones/$(conversationId)).data.participantes;
        allow update, delete: if false; // Mensajes no se pueden editar
      }
    }
    
    // ============================================
    // NOTIFICACIONES
    // ============================================
    match /notificaciones/{notificationId} {
      // Lectura: Solo el destinatario
      allow read: if isAuthenticated() 
        && resource.data.usuarioId == request.auth.uid;
      
      // Crear: Cualquier usuario autenticado puede crear notificaciones
      allow create: if isAuthenticated()
        && hasRequiredFields(['usuarioId', 'tipo', 'mensaje', 'origenUid', 'createdAt']);
      
      // Actualizar: Solo el destinatario, solo campo 'leida'
      allow update: if isAuthenticated() 
        && resource.data.usuarioId == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['leida']);
      
      // Eliminar: Solo el destinatario
      allow delete: if isAuthenticated() 
        && resource.data.usuarioId == request.auth.uid;
    }
    
    // ============================================
    // RESEÑAS (Valoraciones de productos)
    // ============================================
    match /resenas/{resenaId} {
      // Lectura: Pública
      allow read: if true;
      // Crear: Usuario autenticado
      allow create: if isAuthenticated()
        && request.resource.data.usuarioId == request.auth.uid;
      // Actualizar/Eliminar: Solo el autor
      allow update, delete: if isAuthenticated()
        && resource.data.usuarioId == request.auth.uid;
    }
    
    // ============================================
    // LEGACY: Chats antiguos (mantener compatibilidad)
    // ============================================
    match /userChats/{userId} {
      // Lectura: Solo el propietario
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Escritura: El propietario O alguien que está creando un chat con este usuario
      allow write: if isAuthenticated() && 
        (isOwner(userId) || 
         (request.resource.data.keys().hasAny(['chatId', 'with', 'lastMsg']) &&
          request.resource.data.with == request.auth.uid));
      
      match /chats/{chatId} {
        // Lectura: Solo el propietario
        allow read: if isAuthenticated() && isOwner(userId);
        
        // Escritura: El propietario O alguien que está en el chat
        allow write: if isAuthenticated() && 
          (isOwner(userId) || 
           (request.resource.data.keys().hasAny(['chatId', 'with', 'lastMsg']) &&
            request.resource.data.with == request.auth.uid));
      }
    }
    
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
      
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() 
          && request.resource.data.from == request.auth.uid;
      }
    }
    
    // ============================================
    // PIANO TILES SCORES (Ranking del juego)
    // ============================================
    match /pianoTilesScores/{scoreId} {
      // Lectura: Pública (para mostrar ranking)
      allow read: if true;
      
      // Crear: Usuario autenticado, debe ser su propia puntuación
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && hasRequiredFields(['userId', 'userName', 'score', 'timestamp'])
        && request.resource.data.score is number
        && request.resource.data.score >= 0;
      
      // Actualizar/Eliminar: No permitido (puntuaciones son inmutables)
      allow update, delete: if false;
    }
    
    // ============================================
    // DENEGAR TODO LO DEMÁS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
